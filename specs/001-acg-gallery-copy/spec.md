# Feature Specification: Azure Compute Gallery クロスサブスクリプションコピー

**Feature Branch**: `001-acg-gallery-copy`  
**Created**: 2025-11-17  
**Status**: Draft  
**Input**: ユーザー要望（WHAT/WHY）に基づく仕様

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 全イメージの一括コピー (Priority: P1)

利用者はソースの Azure Compute Gallery（同一テナント内）から、ターゲットの別サブスクリプション上の Azure Compute Gallery へ、全イメージ定義およびその全バージョンを一括コピーしたい。

**Why this priority**: 最も一般的な利用目的であり、まず「全部を安全にコピーできる」ことで最大の価値を提供する。

**Independent Test**: ソースに複数のイメージ定義・バージョンを用意し、ツール実行後にターゲット側へ定義・バージョンが重複なく作成されること、既存バージョンはスキップされることを確認する。

**Acceptance Scenarios**:

1. Given ソース/ターゲットのサブスクリプション・RG・ギャラリーが設定済, When 実行, Then すべてのイメージ定義・バージョンが列挙され、ターゲットに存在しないもののみが作成される。
2. Given ターゲットに同一バージョンが既に存在, When 実行, Then 当該バージョンは作成をスキップしログに記録される。

---

### User Story 2 - 条件付きコピー（フィルタ） (Priority: P2)

利用者はイメージ定義名やバージョン名の include / exclude（前方一致・部分一致など）で対象を絞り、必要な一部のみをコピーしたい。

**Why this priority**: 大規模環境では全コピーが非効率で、選択的なコピー需要が高い。

**Independent Test**: フィルタ条件を与えて実行し、条件に合致する定義・バージョンのみが作成（またはスキップ）対象として扱われることを確認する。

**Acceptance Scenarios**:

1. Given include フィルタに一致する定義/バージョンが存在, When 実行, Then 一致するもののみ作成またはスキップ判定される。
2. Given exclude フィルタに一致する定義/バージョンが存在, When 実行, Then それらは対象外となり作成されない。

---

### User Story 3 - ドライランで影響確認 (Priority: P3)

利用者は本番適用前に「何が行われるか」を安全に確認したい。

**Why this priority**: 誤操作や過剰作成を避けるための安全弁として重要。

**Independent Test**: ドライランを有効にして実行し、リソース変更を伴わず、計画される操作（作成/スキップ）の一覧とサマリーが出力されることを確認する。

**Acceptance Scenarios**:

1. Given ドライランモードが有効, When 実行, Then リソースの作成・変更は行われず、予定される操作内容のみが出力される。
2. Given ドライラン結果を確認後に通常実行, When 実行, Then ドライランで示された対象が正しく反映される。

---

### Edge Cases

- ターゲットに同名のイメージ定義が存在し、OS 種別/世代/アーキテクチャ等の変更不可能な属性が不一致の場合はエラーとして処理し、当該定義配下のコピーを中断する。
- ソースのイメージバージョンが参照するレプリケーション地域がターゲットで利用不可の場合、当該バージョンは作成不可としてスキップし、理由を詳細ログに出力する。
- 権限不足（例: ターゲット RG/ギャラリーへの書込権限なし）の場合は即座にエラーで終了し、影響範囲が分かるサマリーを出力する。
- レート制限/一時的エラーが発生した場合はエラーとして記録し、再実行によりリカバリー可能であること（ツールは冪等）を保証する。
- ソースに存在しない（削除済み）参照や、名前規則違反・重複などの不整合が検出された場合は、その対象だけをスキップし、他の対象の処理は継続する。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: ツールはソースの ACG からイメージ定義および各定義配下の全バージョンを列挙できること。
- **FR-002**: ツールはターゲットの ACG に対し、存在しないイメージ定義を作成できること（既存の場合は作成しない）。
- **FR-003**: ツールは各イメージ定義配下のイメージバージョンについて、ターゲットに存在しないバージョンのみを作成し、既存はスキップすること。
- **FR-004**: イメージ定義名・バージョン名の include / exclude フィルタ（前方一致/部分一致など）により、コピー対象を絞り込めること。
- **FR-005**: ドライラン（dry-run）モードを提供し、実際の作成・変更を行わずに予定される操作内容を出力できること。
- **FR-006**: 同一テナント内の別サブスクリプション間コピーのみをサポートし、テナントをまたぐコピーは非対応とすること。
- **FR-007**: 設定は構成ファイル（例: `appsettings.json`）、環境変数、コマンドライン引数のいずれでも上書き可能で、利用者が自環境に合わせて容易に切替できること。
- **FR-008**: コピー時、イメージ定義の変更不可能な属性（OS 種別/世代/アーキテクチャ等）に不整合がある場合は作成を行わずエラーを報告すること。
- **FR-009**: バージョンのレプリケーション地域は原則としてソースの設定を踏襲し、ターゲットで利用不可な地域が含まれる場合は当該バージョンをスキップ（理由をログ）すること。
- **FR-010**: 実行結果は標準出力/標準エラーへ、操作サマリー（作成件数/スキップ件数/失敗件数）とともに出力されること。
- **FR-011**: 例外発生時は処理をフォールバックせず、エラーとして明示し、再実行でリカバリー可能な冪等性を保つこと。
- **FR-012**: ログは少なくとも以下を含むこと（可能な範囲で各操作単位）：対象リソース ID、操作種別（ギャラリー作成/定義作成/バージョン作成等）、HTTP ステータス、Azure エラーコード、メッセージ。
- **FR-013**: ログレベルの方針：情報（進捗/サマリー）、警告（スキップ・非致命的な制約）、エラー（操作失敗）を出し分けること。
- **FR-014**: CLI ツールとして提供し、対話 UI/GUI は提供しないこと。
- **FR-015**: 利用者向け README に前提条件、権限、設定方法、実行例（全コピー/一部コピー/ドライラン）を記載する方針を満たすこと。

### Key Entities *(include if feature involves data)*

- **ソース/ターゲットコンテキスト**: サブスクリプション ID、リソースグループ名、ギャラリー名、認証コンテキスト。
- **ギャラリー（ACG）**: 画像コンテンツの論理的コンテナ。定義とバージョンの親。
- **イメージ定義**: OS 種別/世代/アーキテクチャ等のベース特性を持つ論理定義。
- **イメージバージョン**: 複数地域へのレプリケーション設定や可視性、ストレージ参照を含む実体。定義に従属。
- **フィルタ**: include / exclude のパターン集合（前方一致/部分一致等）。
- **実行モード**: 通常実行 / ドライラン。
- **設定**: 構成ファイル・環境変数・CLI 引数で上書き可能なパラメータ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: フィルタで選択された対象のうち、権限/クォータ/地域制約に該当しないものは 100% 成功裏にコピーが完了する。
- **SC-002**: ドライラン出力と通常実行の差分は 0 件（同一条件下）であり、ドライランの記載どおりに作成/スキップが行われる。
- **SC-003**: ログ必須項目（リソース ID/操作種別/HTTP ステータス/エラーコード/メッセージ）の欠落率 0%。
- **SC-004**: 冪等性: 同一条件での再実行時、重複作成 0 件・スキップ判定が正しく行われる。
- **SC-005**: 初回セットアップ（前提確認〜設定〜ドライラン〜本実行）を README に従って 30 分以内に完了できるユーザーが 80% 以上。
- **SC-006**: 大規模コピー時でも、処理中の進捗や結果サマリーが常に把握でき、ユーザーは失敗対象と理由を特定できる（トラブルシュート可能性 100%）。

---

### Assumptions / 非機能前提

- 同一テナント内でのクロスサブスクリプションコピーのみを対象とする（テナント跨ぎは非対応）。
- - CMK 等の特殊な暗号化/コンプライアンス要件は対象外。該当バージョンはスキップし理由をログに残す。

### 2.5 Implementation Scope and Limitations（実装スコープと制限事項）

本ツールは、Azure Compute Gallery の基本的なクロスサブスクリプションコピー機能を提供しますが、
以下の制限事項があります。これらは Azure SDK API の制約および実装の簡素化のために設定されています。

#### L-001: 変更不可能属性の事前検証なし

**制限内容**:
- イメージ定義の変更不可能属性（OS種別、OS状態、Hyper-V世代、アーキテクチャ）の事前検証を実施しません
- ターゲットに同名のイメージ定義が存在し、これらの属性が異なる場合、Azure API実行時にエラーが発生します

**動作**:
- Azure API実行時のエラーを詳細なログで記録
- 当該操作は失敗として `CopySummary` に記録
- 他のイメージ定義・バージョンのコピーは継続

**対応方法**: 
エラーログを確認し、ターゲットの既存イメージ定義を手動で削除するか、異なる名前でコピーしてください。

#### L-002: ターゲットリージョン設定の簡素化

**制限内容**:
- ソースイメージのターゲットリージョン設定（複数リージョンへのレプリケーション、リージョンごとのレプリカ数、
  リージョン固有のストレージタイプ）をコピーしません

**動作**:
- ターゲットリージョン: ターゲットギャラリーの所在リージョンのみ
- レプリカ数: ソースの全体レプリカ数を継承（デフォルト: 1）
- ストレージタイプ: Standard_LRS（Azure SDKデフォルト）

**対応方法**: 
マルチリージョンレプリケーションが必要な場合は、コピー後に Azure Portal または Azure CLI で手動設定してください。

#### L-003: ストレージアカウントタイプの固定

**制限内容**:
- ストレージアカウントタイプ（Standard_LRS、Premium_LRS、Standard_ZRS等）の指定をサポートしません
- Azure SDK のデフォルト設定（Standard_LRS）が使用されます

**対応方法**: 
特定のストレージタイプが必要な場合は、コピー後に Azure Portal または Azure CLI で設定変更を試みてください。
ただし、イメージバージョンは作成後変更不可のため、再作成が必要になる場合があります。

#### L-004: カスタマー管理キー (CMK) 暗号化の非対応

**制限内容**:
- カスタマー管理キー（CMK）による暗号化を使用しているイメージバージョンのコピーをサポートしません

**動作**:
1. コピー実行前に、各イメージバージョンの暗号化設定を自動検出
2. CMK暗号化が検出された場合、当該バージョンを自動的にスキップ
3. スキップ理由をログに記録（WARNING レベル）
4. 他のバージョンのコピーは継続

**理由**:
- CMK暗号化されたイメージをプラットフォーム管理キーでコピーすると、セキュリティレベルが低下
- コピー後に再度CMK暗号化を設定するには、イメージバージョンの再作成が必要
- クロスサブスクリプションでのCMKキー参照には追加の権限設定が必要

**対応方法**: 
CMK暗号化が必要な場合は、以下の手順を推奨します:
1. ターゲットサブスクリプションでCMK用のKey Vaultとキーを作成
2. Azure Portal または Azure CLI で手動コピーを実行
3. コピー時にターゲットのCMKを指定

#### L-005: 詳細メタデータの簡素化

**制限内容**:
- `EndOfLifeDate`、`ExcludeFromLatest` などの詳細メタデータは部分的にのみコピー
- セキュリティ機能（TrustedLaunch、ConfidentialVM）の設定は検証のみ（コピーは試行）

**動作**:
- 基本的なメタデータ（レプリカ数、除外フラグ）は可能な限りコピー
- 複雑な設定はデフォルト値が使用される場合がある

**対応方法**: 
コピー後に Azure Portal で設定を確認し、必要に応じて手動調整してください。

## 3. Functional Requirements（機能要件）
- 具体的な SDK バージョンや内部 API 呼び出し、クラス設計等の HOW は本仕様では扱わない。
- ディレクトリ構成・ファイル命名は Spec Kit の標準（例: `specs/NNN-acg-gallery-copy/spec.md`）に従い、最終決定は Plan フェーズで行う。
